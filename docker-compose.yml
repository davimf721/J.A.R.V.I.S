services:
  # ==================== INFRAESTRUTURA ====================
  
  # Ollama - Local LLM
  ollama:
    image: ollama/ollama:latest
    container_name: jarvis-ollama
    ports:
      - "11435:11435"
    environment:
      OLLAMA_HOST: "0.0.0.0:11435"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - jarvis-network
    restart: unless-stopped
    # Para pré-carregar o modelo na inicialização
    # Descomente e ajuste conforme necessário
    # entrypoint: bash -c "ollama serve & sleep 10 && ollama pull kimi-k2.5:cloud"

  # PostgreSQL - Banco de dados principal
  postgres:
    image: postgres:16-alpine
    container_name: jarvis-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-jarvis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-jarvis_secure_password}
      POSTGRES_DB: ${POSTGRES_DB:-jarvis_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - jarvis-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-jarvis} -d ${POSTGRES_DB:-jarvis_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Cache e sessões
  redis:
    image: redis:7-alpine
    container_name: jarvis-redis
    command: redis-server
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - jarvis-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ - Message Queue
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: jarvis-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-jarvis}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-jarvis_queue_pwd}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-jarvis}
    ports:
      - "5672:5672"      # AMQP
      - "15672:15672"    # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - jarvis-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ChromaDB - Banco vetorial
  chromadb:
    image: ghcr.io/chroma-core/chroma:latest
    container_name: jarvis-chromadb
    environment:
      IS_PERSISTENT: "TRUE"
      ANONYMIZED_TELEMETRY: "FALSE"
    ports:
      - "8200:8000"
    volumes:
      - chromadb_data:/data
    networks:
      - jarvis-network
    restart: unless-stopped

  # Minio - S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: jarvis-minio
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
    ports:
      - "9000:9000"      # API
      - "9001:9001"      # Console
    volumes:
      - minio_data:/data
    networks:
      - jarvis-network
    command: server /data --console-address ":9001"
    restart: unless-stopped

  # ==================== MICROSERVIÇOS ====================

  # LLM Service
  llm-service:
    build:
      context: .
      dockerfile: services/llm-service/Dockerfile
    container_name: jarvis-llm-service
    environment:
      OLLAMA_URL: "http://ollama:11435/api/generate"
      OLLAMA_MODEL: ${OLLAMA_MODEL:-kimi-k2.5:cloud}
      LLM_TIMEOUT: ${LLM_TIMEOUT:-300}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: INFO
    ports:
      - "8001:8001"
    depends_on:
      - ollama
      - redis
    networks:
      - jarvis-network
    restart: unless-stopped

  # News Service
  news-service:
    build:
      context: .
      dockerfile: services/news-service/Dockerfile
    container_name: jarvis-news-service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: INFO
    ports:
      - "8002:8002"
    depends_on:
      - redis
    networks:
      - jarvis-network
    restart: unless-stopped

  # Script Service
  script-service:
    build:
      context: .
      dockerfile: services/script-service/Dockerfile
    container_name: jarvis-script-service
    environment:
      LLM_SERVICE_URL: "http://llm-service:8001"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: INFO
    ports:
      - "8003:8003"
    depends_on:
      - llm-service
      - redis
    networks:
      - jarvis-network
    restart: unless-stopped

  # TTS Service
  tts-service:
    build:
      context: .
      dockerfile: services/tts-service/Dockerfile
    container_name: jarvis-tts-service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: INFO
    ports:
      - "8004:8004"
    depends_on:
      - redis
    volumes:
      - tts_output:/tmp/tts_output
    networks:
      - jarvis-network
    restart: unless-stopped

  # Memory Service
  memory-service:
    build:
      context: .
      dockerfile: services/memory-service/Dockerfile
    container_name: jarvis-memory-service
    environment:
      CHROMADB_HOST: chromadb
      CHROMADB_PORT: 8000
      CHROMADB_PERSIST_DIR: /data/chromadb
      LOG_LEVEL: INFO
    ports:
      - "8005:8005"
    depends_on:
      - chromadb
    volumes:
      - memory_data:/data/chromadb
    networks:
      - jarvis-network
    restart: unless-stopped

  # Orchestrator (API principal)
  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: jarvis-orchestrator
    environment:
      API_GATEWAY_URL: "http://localhost:8010"
      LLM_SERVICE_URL: "http://llm-service:8001"
      NEWS_SERVICE_URL: "http://news-service:8002"
      SCRIPT_SERVICE_URL: "http://script-service:8003"
      TTS_SERVICE_URL: "http://tts-service:8004"
      MEMORY_SERVICE_URL: "http://memory-service:8005"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: INFO
    ports:
      - "8010:8010"
    depends_on:
      - llm-service
      - news-service
      - script-service
      - tts-service
      - memory-service
      - redis
    networks:
      - jarvis-network
    restart: unless-stopped

  # ==================== MONITORAMENTO (OPCIONAL) ====================

  # Prometheus - Coleta de métricas
  prometheus:
    image: prom/prometheus:latest
    container_name: jarvis-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - jarvis-network
    restart: unless-stopped

  # Grafana - Visualização de métricas
  grafana:
    image: grafana/grafana:latest
    container_name: jarvis-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - jarvis-network
    restart: unless-stopped

# ==================== VOLUMES ====================
volumes:
  ollama_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  chromadb_data:
    driver: local
  minio_data:
    driver: local
  tts_output:
    driver: local
  memory_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# ==================== REDES ====================
networks:
  jarvis-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
